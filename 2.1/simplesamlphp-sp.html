<!DOCTYPE html>
<html lang="en">
  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Language" content="en">
  <meta name="google-site-verification" content="2S8M18BgYs8cLRL6ClTrfW_xGxfFtMZu2b2jhjrNlss">

  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>SimpleSAMLphp Documentation</title>

  <link rel="stylesheet" href="/res/css/style.css">
  <link rel="stylesheet" href="/res/css/layout.css">
</head>
<body>
<header>
 <div id="header">
  <div class="right">
   <form action="https://www.google.com/cse" method="get" style="margin-top: 2.5rem; margin-right: 2rem">
    <input name="cx" type="hidden" value="004202914224971217557:8ks4jjstupq"/>
    <input name="siteurl" type="hidden" value="www.google.com/cse/home?cx=004202914224971217557:8ks4jjstupq"/>
    <input name="adkw" type="hidden" value="AELymgVJ6Sk-kOvUjbxvgShTLwiFlma2evFuVCh0r8q23vn_4eVnkcdnPfbgMvYUTpJpVlb-KkGAKkbn0i-AlWHsVRR9O0J4CNb6cXFkEKRdjXxsC_NlVD4"/>
    <input name="q" placeholder="Search" type="search" value=""/>
   </form>
  </div>
  <div class="v-center logo-header">
   <div id="logo">
    <a href="https://simplesamlphp.org" style="color: #fff; text-decoration: none">
     <span class="simple">
      Simple
     </span>
     <span class="saml">
      SAML
     </span>
     <span class="simple">
      php
     </span>
    </a>
   </div>
  </div>
 </div>
 <!-- Grey header bar below -->
 <nav>
  <div id="headerbar" style="clear: both">
   <p id="breadcrumb">
    <a href="https://simplesamlphp.org">
     Home
    </a>
    Â» Documentation
   </p>
   <div class="mtoolbar">
    <div class="menuitem">
     <a href="/docs/2.3/index.html">
      2.3 (stable)
     </a>
    </div>
    <div class="menuitem">
     <a href="/docs/2.2/index.html">
      2.2
     </a>
    </div>
    <div class="menuitem">
     <a href="/docs/2.1/index.html">
      2.1
     </a>
    </div>
    <div class="menuitem">
     <a href="/docs/2.0/index.html">
      2.0
     </a>
    </div>
    <div class="menuitem first">
     <a href="/docs/devel/index.html">
      devel
     </a>
    </div>
    <div class="menuitem last">
     <a href="/docs/contributed_modules.html">
      Contributed modules
     </a>
    </div>
   </div>
   <br style="height: 0px; clear: both"/>
  </div>
  <!-- /#headerbar -->
 </nav>
 <div id="content">
 </div>
</header>
<main><h1 id="simplesamlphp-service-provider-quickstart">
 SimpleSAMLphp Service Provider QuickStart
</h1>
<div class="toc">
 <ul>
  <li>
   <a href="#simplesamlphp-service-provider-quickstart">
    SimpleSAMLphp Service Provider QuickStart
   </a>
   <ul>
    <li>
     <a href="#configuring-the-sp">
      Configuring the SP
     </a>
     <ul>
      <li>
       <a href="#enabling-a-certificate-for-your-service-provider">
        Enabling a certificate for your Service Provider
       </a>
      </li>
     </ul>
    </li>
    <li>
     <a href="#adding-idps-to-the-sp">
      Adding IdPs to the SP
     </a>
    </li>
    <li>
     <a href="#setting-the-default-idp">
      Setting the default IdP
     </a>
    </li>
    <li>
     <a href="#exchange-metadata-with-the-idp">
      Exchange metadata with the IdP
     </a>
    </li>
    <li>
     <a href="#test-the-sp">
      Test the SP
     </a>
    </li>
    <li>
     <a href="#integrating-authentication-with-your-own-application">
      Integrating authentication with your own application
     </a>
    </li>
    <li>
     <a href="#support">
      Support
     </a>
    </li>
   </ul>
  </li>
 </ul>
</div>
<p>
 This guide will describe how to configure SimpleSAMLphp as a service
provider (SP). You should previously have installed SimpleSAMLphp as
described in the
 <a href="simplesamlphp-install.html">
  SimpleSAMLphp installation instructions
 </a>
 .
</p>
<h2 id="configuring-the-sp">
 Configuring the SP
</h2>
<p>
 The SP is configured by an entry in
 <code>
  config/authsources.php
 </code>
 .
</p>
<p>
 This is a minimal
 <code>
  authsources.php
 </code>
 for a SP:
</p>
<div class="highlight">
 <pre><span></span><code><span class="cp">&lt;?php</span>
<span class="nv">$config</span> <span class="o">=</span> <span class="p">[</span>

    <span class="cm">/* This is the name of this authentication source, and will be used to access it later. */</span>
    <span class="s1">'default-sp'</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="s1">'saml:SP'</span><span class="p">,</span>
        <span class="s1">'entityID'</span> <span class="o">=&gt;</span> <span class="s1">'https://myapp.example.org/'</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">];</span>
</code></pre>
</div>
<p>
 The entity ID must be a URI, that is unlikely to change for technical or
political reasons. We recommend it to be a domain name that you own.
Like above, if your organization's main domain is
 <code>
  example.org
 </code>
 and this SP is
for the application
 <code>
  myapp
 </code>
 .  The URL does not have to resolve to actual
content, it's just an identifier. Hence you don't need to and should not change
it if the actual domain of your application changes.
</p>
<p>
 For guidance in picking an entityID, see
 <a href="https://spaces.at.internet2.edu/display/federation/saml-metadata-entityid">
  InCommon's best practice
 </a>
 on the matter.
</p>
<p>
 For more information about additional options available for the SP,
see the
 <a href="./saml/sp.html">
  <code>
   saml:SP
  </code>
  reference
 </a>
 .
</p>
<p>
 If you want multiple Service Providers in the same site and installation,
you can add more entries in the
 <code>
  authsources.php
 </code>
 configuration. If so
remember to set the EntityID explicitly. Here is an example:
</p>
<div class="highlight">
 <pre><span></span><code><span class="x">    'sp1' =&gt; [</span>
<span class="x">        'saml:SP',</span>
<span class="x">        'entityID' =&gt; 'https://myapp.example.org/',</span>
<span class="x">    ],</span>
<span class="x">    'sp2' =&gt; [</span>
<span class="x">        'saml:SP',</span>
<span class="x">        'entityID' =&gt; 'https://myotherapp.example.org/',</span>
<span class="x">    ],</span>
</code></pre>
</div>
<h3 id="enabling-a-certificate-for-your-service-provider">
 Enabling a certificate for your Service Provider
</h3>
<p>
 Some Identity Providers / Federations may require that your Service Providers
holds a certificate. If you enable a certificate for your Service Provider,
it may be able to sign requests and response sent to the Identity Provider,
as well as receiving encrypted responses.
</p>
<p>
 Create a self-signed certificate in the
 <code>
  cert/
 </code>
 directory.
</p>
<div class="highlight">
 <pre><span></span><code><span class="nb">cd</span><span class="w"> </span>cert
openssl<span class="w"> </span>req<span class="w"> </span>-newkey<span class="w"> </span>rsa:3072<span class="w"> </span>-new<span class="w"> </span>-x509<span class="w"> </span>-days<span class="w"> </span><span class="m">3652</span><span class="w"> </span>-nodes<span class="w"> </span>-out<span class="w"> </span>saml.crt<span class="w"> </span>-keyout<span class="w"> </span>saml.pem
</code></pre>
</div>
<p>
 Then edit your
 <code>
  authsources.php
 </code>
 entry, and add references to your certificate:
</p>
<div class="highlight">
 <pre><span></span><code><span class="x">    'default-sp' =&gt; [</span>
<span class="x">        'saml:SP',</span>
<span class="x">        'entityID' =&gt; 'https://myapp.example.org/',</span>
<span class="x">        'privatekey' =&gt; 'saml.pem',</span>
<span class="x">        'certificate' =&gt; 'saml.crt',</span>
<span class="x">    ],</span>
</code></pre>
</div>
<h2 id="adding-idps-to-the-sp">
 Adding IdPs to the SP
</h2>
<p>
 The service provider you are configuring needs to know about the identity
providers you are going to connect to it. This is configured by metadata
stored in
 <code>
  metadata/saml20-idp-remote.php
 </code>
 .
</p>
<p>
 This is a minimal example of a
 <code>
  metadata/saml20-idp-remote.php
 </code>
 metadata file:
</p>
<div class="highlight">
 <pre><span></span><code><span class="cp">&lt;?php</span>
<span class="nv">$metadata</span><span class="p">[</span><span class="s1">'https://example.org/saml-idp'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'SingleSignOnService'</span>  <span class="o">=&gt;</span> <span class="s1">'https://example.org/simplesaml/module.php/saml/idp/singleSignOnService'</span><span class="p">,</span>
    <span class="s1">'SingleLogoutService'</span>  <span class="o">=&gt;</span> <span class="s1">'https://example.org/simplesaml/module.php/saml/idp/singleLogout'</span><span class="p">,</span>
    <span class="s1">'certificate'</span>          <span class="o">=&gt;</span> <span class="s1">'example.pem'</span><span class="p">,</span>
<span class="p">];</span>
</code></pre>
</div>
<p>
 <code>
  example.pem
 </code>
 under your
 <code>
  cert/
 </code>
 directory contains the certificate the
identity provider uses for signing assertions.
</p>
<p>
 For more information about available options in the idp-remote metadata
files, see the
 <a href="simplesamlphp-reference-idp-remote.html">
  IdP remote reference
 </a>
 .
</p>
<p>
 If you have the metadata of the remote IdP as an XML file, you can use the
built-in XML to SimpleSAMLphp metadata converter, which by default is
available at
 <code>
  /module.php/admin/federation/metadata-converter
 </code>
 in
your SimpleSAMLphp installation.
</p>
<p>
 Note that the idp-remote file lists all IdPs you trust.
You should remove all IdPs that you don't use.
</p>
<h2 id="setting-the-default-idp">
 Setting the default IdP
</h2>
<p>
 An option in the authentication source allows you to configure which IdP should
be used. This is the
 <code>
  idp
 </code>
 option.
</p>
<div class="highlight">
 <pre><span></span><code><span class="cp">&lt;?php</span>
<span class="nv">$config</span> <span class="o">=</span> <span class="p">[</span>

    <span class="s1">'default-sp'</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="s1">'saml:SP'</span><span class="p">,</span>

        <span class="cm">/*</span>
<span class="cm">         * The entity ID of the IdP this should SP should contact.</span>
<span class="cm">         * Can be NULL/unset, in which case the user will be shown a list of available IdPs.</span>
<span class="cm">         */</span>
        <span class="s1">'idp'</span> <span class="o">=&gt;</span> <span class="s1">'https://example.org/saml-idp'</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">];</span>
</code></pre>
</div>
<h2 id="exchange-metadata-with-the-idp">
 Exchange metadata with the IdP
</h2>
<p>
 In order to complete the connection between your SP and an IdP, you must
exchange the metadata of your SP with the IdP. The metadata of your SP can be
found in the
 <em>
  Federation
 </em>
 tab of the web interface. Copy the SAML 2.0 XML
Metadata document automatically generated by SimpleSAMLphp and send it to the
administrator of the IdP. You can also send them the dedicated URL of your
metadata, so that they can fetch it periodically and obtain automatically any
changes that you may perform to your SP.
</p>
<p>
 You will also need to add the metadata of the IdP. Ask them to provide you with
their metadata, and parse it using the
 <em>
  XML to SimpleSAMLphp metadata converter
 </em>
 tool available also in the
 <em>
  Federation
 </em>
 tab of the web interface. Copy the
resulting parsed metadata and paste it with a text editor into the
 <code>
  metadata/saml20-idp-remote.php
 </code>
 file in your SimpleSAMLphp directory.
</p>
<p>
 If you intend to add your SP to a federation, the procedure for managing trust
in federations will differ, but the common part is that you would need to
provide the
 <em>
  SAML 2.0 metadata of your SP
 </em>
 , and register that with the
federation administration. You will probably be required too to consume
the federation metadata periodically. Read more about
 <a href="/docs/contrib_modules/metarefresh/simplesamlphp-automated_metadata.html">
  automated metadata management
 </a>
 to learn more about that.
</p>
<h2 id="test-the-sp">
 Test the SP
</h2>
<p>
 After the metadata is configured on the IdP, you should be able to test the
configuration. The admin module of SimpleSAMLphp has a tab to test
authentication sources. There you should a list of authentication sources,
including the one you have created for the SP.
</p>
<p>
 After you click the link for that authentication source, you will be
redirected to the IdP. After entering your credentials, you should be
redirected back to the test page.
The test page should contain a list of your attributes:
</p>
<p>
 <img alt="Screenshot of the status page after a user has successfully authenticated" src="resources/simplesamlphp-sp/screenshot-example.png"/>
</p>
<p>
 For a better looking, more advanced Discovery Service with tabs and live
search, you may want to use the
 <code>
  discopower
 </code>
 module.
</p>
<h2 id="integrating-authentication-with-your-own-application">
 Integrating authentication with your own application
</h2>
<p>
 The API is documented in
 <a href="simplesamlphp-sp-api.html">
  the SP API reference
 </a>
 .
</p>
<p>
 For those web resources you want to protect, you must add a few
lines of PHP code:
</p>
<ul>
 <li>
  Register the SimpleSAMLphp classes with the PHP autoloader.
 </li>
 <li>
  Require authentication of the user for those places it is required.
 </li>
 <li>
  Access the users attributes.
 </li>
</ul>
<p>
 Example code:
</p>
<p>
 We start off with loading a file which registers the SimpleSAMLphp classes
with the autoloader.
</p>
<div class="highlight">
 <pre><span></span><code><span class="x">require_once('../../src/_autoload.php');</span>
</code></pre>
</div>
<p>
 We select our authentication source:
</p>
<div class="highlight">
 <pre><span></span><code><span class="x">$as = new \SimpleSAML\Auth\Simple('default-sp');</span>
</code></pre>
</div>
<p>
 We then require authentication:
</p>
<div class="highlight">
 <pre><span></span><code><span class="x">$as-&gt;requireAuth();</span>
</code></pre>
</div>
<p>
 And print the attributes:
</p>
<div class="highlight">
 <pre><span></span><code><span class="x">$attributes = $as-&gt;getAttributes();</span>
<span class="x">print_r($attributes);</span>
</code></pre>
</div>
<p>
 Each attribute name can be used as an index into $attributes to obtain the
value. Every attribute value is an array - a single-valued attribute is an
array of a single element.
</p>
<p>
 We can also request authentication with a specific IdP:
</p>
<div class="highlight">
 <pre><span></span><code><span class="x">$as-&gt;login([</span>
<span class="x">    'saml:idp' =&gt; 'https://example.org/saml-idp',</span>
<span class="x">]);</span>
</code></pre>
</div>
<p>
 Other options are also available.
Take a look in the documentation for the
 <a href="./saml/sp.html">
  SP module
 </a>
 for a list
of all parameters.
</p>
<p>
 If we are using PHP sessions in SimpleSAMLphp and in the application we are
protecting, SimpleSAMLphp will close any existing session when invoked for the
first time, and its own session will prevail afterwards. If you want to restore
your own session after calling SimpleSAMLphp, you can do so by cleaning up the
session like this:
</p>
<div class="highlight">
 <pre><span></span><code><span class="x">$session = \SimpleSAML\Session::getSessionFromRequest();</span>
<span class="x">$session-&gt;cleanup();</span>
</code></pre>
</div>
<p>
 If you don't cleanup SimpleSAMLphp's session and try to use $_SESSION
afterwards, you won't be using your own session and all your data is
likely to get lost or inaccessible.
</p>
<p>
 Note that if your application uses a
 <a href="https://www.php.net/manual/en/function.session-set-save-handler.php">
  custom session handler
 </a>
 ,
SimpleSAMLphp will use it as well. This can lead to problems because
SimpleSAMLphp's stand-alone web UI uses the default PHP session handlers.
Therefore, you may need to unset the custom handler before making any calls to SimpleSAMLphp:
</p>
<div class="highlight">
 <pre><span></span><code><span class="x">// use custom save handler</span>
<span class="x">session_set_save_handler($handler);</span>
<span class="x">session_start();</span>

<span class="x">// close session and restore default handler</span>
<span class="x">session_write_close();</span>
<span class="x">session_set_save_handler(new SessionHandler(), true);</span>

<span class="x">// use SimpleSAML\Session</span>
<span class="x">$session = \SimpleSAML\Session::getSessionFromRequest();</span>
<span class="x">$session-&gt;cleanup();</span>
<span class="x">session_write_close();</span>

<span class="x">// back to custom save handler</span>
<span class="x">session_set_save_handler($handler);</span>
<span class="x">session_start();</span>
</code></pre>
</div>
<h2 id="support">
 Support
</h2>
<p>
 If you need help to make this work, or want to discuss SimpleSAMLphp with other
users of the software, you are fortunate: Around SimpleSAMLphp there is a great
Open source community, and you are welcome to join! The forums are open for you
to ask questions, contribute answers other further questions, request
improvements or contribute with code or plugins of your own.
</p>
<ul>
 <li>
  <a href="https://simplesamlphp.org">
   SimpleSAMLphp homepage
  </a>
 </li>
 <li>
  <a href="https://simplesamlphp.org/docs/">
   List of all available SimpleSAMLphp documentation
  </a>
 </li>
 <li>
  <a href="https://simplesamlphp.org/lists">
   Join the SimpleSAMLphp user's mailing list
  </a>
 </li>
</ul>
</main></body>
</html>
