<!DOCTYPE html>
<html lang="en">
  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Language" content="en">
  <meta name="google-site-verification" content="2S8M18BgYs8cLRL6ClTrfW_xGxfFtMZu2b2jhjrNlss">

  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>SimpleSAMLphp Documentation</title>

  <link rel="stylesheet" href="/res/css/style.css">
  <link rel="stylesheet" href="/res/css/layout.css">
</head>
<body>
<header>
 <div id="header">
  <div class="right">
   <form action="https://www.google.com/cse" method="get" style="margin-top: 2.5rem; margin-right: 2rem">
    <input name="cx" type="hidden" value="004202914224971217557:8ks4jjstupq"/>
    <input name="siteurl" type="hidden" value="www.google.com/cse/home?cx=004202914224971217557:8ks4jjstupq"/>
    <input name="adkw" type="hidden" value="AELymgVJ6Sk-kOvUjbxvgShTLwiFlma2evFuVCh0r8q23vn_4eVnkcdnPfbgMvYUTpJpVlb-KkGAKkbn0i-AlWHsVRR9O0J4CNb6cXFkEKRdjXxsC_NlVD4"/>
    <input name="q" placeholder="Search" type="search" value=""/>
   </form>
  </div>
  <div class="v-center logo-header">
   <div id="logo">
    <a href="https://simplesamlphp.org" style="color: #fff; text-decoration: none">
     <span class="simple">
      Simple
     </span>
     <span class="saml">
      SAML
     </span>
     <span class="simple">
      php
     </span>
    </a>
   </div>
  </div>
 </div>
 <!-- Grey header bar below -->
 <nav>
  <div id="headerbar" style="clear: both">
   <p id="breadcrumb">
    <a href="https://simplesamlphp.org">
     Home
    </a>
    » Documentation
   </p>
   <div class="mtoolbar">
    <div class="menuitem first">
     <a href="/docs/latest/index.html">
      latest
     </a>
    </div>
    <div class="menuitem">
     <a href="/docs/1.19/index.html">
      1.19
     </a>
    </div>
    <div class="menuitem">
     <a href="/docs/1.18/index.html">
      1.18
     </a>
    </div>
    <div class="menuitem">
     <a href="/docs/1.17/index.html">
      1.17
     </a>
    </div>
    <div class="menuitem">
     <a href="/docs/1.16/index.html">
      1.16
     </a>
    </div>
    <div class="menuitem last">
     <a href="/docs/contributed_modules.html">
      Contributed modules
     </a>
    </div>
   </div>
   <br style="height: 0px; clear: both"/>
  </div>
  <!-- /#headerbar -->
 </nav>
 <div id="content">
 </div>
</header><main><h1 id="automated-metadata-management">
 Automated Metadata Management
</h1>
<!-- 
  This file is written in Markdown syntax. 
  For more information about how to use the Markdown syntax, read here:
  http://daringfireball.net/projects/markdown/syntax
-->
<!-- {{TOC}} -->
<h2 id="introduction">
 Introduction
</h2>
<p>
 If you want to connect an Identity Provider, or a Service Provider to a
 <strong>
  federation
 </strong>
 , you need to setup metadata for the entries that you trust. In many federations, in particular federations based upon the Shibboleth software, it is normal to setup automated distribution of metadata using the SAML 2.0 Metadata XML Format.
</p>
<p>
 Some central administration or authority, provides a URL with a SAML 2.0 document including metadata for all entities in the federation.
</p>
<p>
 The present document explains how to setup automated downloading and parsing of a metadata document on a specific URL.
</p>
<h2 id="preparations">
 Preparations
</h2>
<p>
 You need to enable the following modules:
</p>
<ol>
 <li>
  <a href="./cron/cron.html">
   cron
  </a>
 </li>
 <li>
  metarefresh
 </li>
</ol>
<p>
 The cron module allows you to do tasks regularly, by setting up a cron job that calls a hook in SimpleSAMLphp.
</p>
<p>
 The metarefresh module will download and parse the metadata document and store it in metadata files cached locally.
</p>
<p>
 First, you will need to copy the
 <code>
  config-templates
 </code>
 files of the two modules above into the global
 <code>
  config/
 </code>
 directory.
</p>
<div class="codehilite">
 <pre><span></span><code><span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">simplesamlphp</span><span class="p">]</span><span class="w"> </span><span class="n">cd</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">simplesamlphp</span><span class="w"></span>
<span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">simplesamlphp</span><span class="w"> </span><span class="n">simplesamlphp</span><span class="p">]</span><span class="w"> </span><span class="n">touch</span><span class="w"> </span><span class="n">modules</span><span class="o">/</span><span class="n">cron</span><span class="o">/</span><span class="n">enable</span><span class="w"></span>
<span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">simplesamlphp</span><span class="w"> </span><span class="n">simplesamlphp</span><span class="p">]</span><span class="w"> </span><span class="n">cp</span><span class="w"> </span><span class="n">modules</span><span class="o">/</span><span class="n">cron</span><span class="o">/</span><span class="n">config</span><span class="o">-</span><span class="n">templates</span><span class="o">/*.</span><span class="n">php</span><span class="w"> </span><span class="n">config</span><span class="o">/</span><span class="w"></span>
<span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">simplesamlphp</span><span class="w"> </span><span class="n">simplesamlphp</span><span class="p">]</span><span class="w"> </span><span class="n">touch</span><span class="w"> </span><span class="n">modules</span><span class="o">/</span><span class="n">metarefresh</span><span class="o">/</span><span class="n">enable</span><span class="w"></span>
<span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">simplesamlphp</span><span class="w"> </span><span class="n">simplesamlphp</span><span class="p">]</span><span class="w"> </span><span class="n">cp</span><span class="w"> </span><span class="n">modules</span><span class="o">/</span><span class="n">metarefresh</span><span class="o">/</span><span class="n">config</span><span class="o">-</span><span class="n">templates</span><span class="o">/*.</span><span class="n">php</span><span class="w"> </span><span class="n">config</span><span class="o">/</span><span class="w"></span>
</code></pre>
</div>
<h2 id="testing-it-manually">
 Testing it manually
</h2>
<p>
 It is often useful to verify that the metadata sources we want to use can be parsed and verified by metarefresh, before actually
configuring it. We can do so in the command line, by invoking metarefresh with the URL of the metadata set we want to check. For
instance, if we want to configure the metadata of the SWITCH AAI Test Federation:
</p>
<div class="codehilite">
 <pre><span></span><code>cd modules/metarefresh/bin
./metarefresh.php -s http://metadata.aai.switch.ch/metadata.aaitest.xml
</code></pre>
</div>
<p>
 The
 <code>
  -s
 </code>
 option sends the output to the console (for testing purposes). If the output makes sense, continue. If you get a lot of error messages, try to read them and fix the problems that might be causing them. If you are having problems and you can't figure out the cause, you can always send an e-mail to the SimpleSAMLphp mailing list and ask for advice.
</p>
<h2 id="configuring-the-metarefresh-module">
 Configuring the metarefresh module
</h2>
<p>
 Now we are going to proceed to configure the metarefresh module. First, edit the appropriate configuration file:
</p>
<div class="codehilite">
 <pre><span></span><code><span class="o">[</span><span class="n">root@simplesamlphp simplesamlphp</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">vi</span><span class="w"> </span><span class="n">config</span><span class="o">/</span><span class="n">config</span><span class="o">-</span><span class="n">metarefresh</span><span class="p">.</span><span class="n">php</span><span class="w"></span>
</code></pre>
</div>
<p>
 Here's an example of a possible configuration for both the Kalmar Federation and UK Access Management Federation:
</p>
<div class="codehilite">
 <pre><span></span><code><span class="n">$config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">array</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="p">'</span><span class="n">sets</span><span class="p">'</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">array</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="p">'</span><span class="n">kalmar</span><span class="p">'</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">array</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="p">'</span><span class="n">cron</span><span class="p">'</span><span class="w">    </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">array</span><span class="p">('</span><span class="n">hourly</span><span class="p">'),</span><span class="w"></span>
<span class="w">      </span><span class="p">'</span><span class="n">sources</span><span class="p">'</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">array</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">array</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="p">'</span><span class="n">src</span><span class="p">'</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">'</span><span class="nl">https:</span><span class="c1">//kalmar.feide.no/simplesaml/module.php/aggregator/?id=kalmarcentral&amp;mimetype=text/plain&amp;exclude=norway',</span>
<span class="w">          </span><span class="p">'</span><span class="n">certificates</span><span class="p">'</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">array</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="p">'</span><span class="n">current</span><span class="p">.</span><span class="n">crt</span><span class="p">',</span><span class="w"></span>
<span class="w">            </span><span class="p">'</span><span class="n">rollover</span><span class="p">.</span><span class="n">crt</span><span class="p">',</span><span class="w"></span>
<span class="w">          </span><span class="p">),</span><span class="w"></span>
<span class="w">          </span><span class="p">'</span><span class="n">template</span><span class="p">'</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">array</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="p">'</span><span class="n">tags</span><span class="p">'</span><span class="w">  </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">array</span><span class="p">('</span><span class="n">kalmar</span><span class="p">'),</span><span class="w"></span>
<span class="w">            </span><span class="p">'</span><span class="n">authproc</span><span class="p">'</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">array</span><span class="p">(</span><span class="w"></span>
<span class="w">              </span><span class="mh">51</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">array</span><span class="p">('</span><span class="n">class</span><span class="p">'</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">'</span><span class="nl">core:</span><span class="n">AttributeMap</span><span class="p">',</span><span class="w"> </span><span class="p">'</span><span class="n">oid2name</span><span class="p">'),</span><span class="w"></span>
<span class="w">            </span><span class="p">),</span><span class="w"></span>
<span class="w">          </span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="p">'</span><span class="n">expireAfter</span><span class="p">'</span><span class="w">     </span><span class="o">=&gt;</span><span class="w"> </span><span class="mh">60</span><span class="o">*</span><span class="mh">60</span><span class="o">*</span><span class="mh">24</span><span class="o">*</span><span class="mh">4</span><span class="p">,</span><span class="w"> </span><span class="c1">// Maximum 4 days cache time.</span>
<span class="w">      </span><span class="p">'</span><span class="n">outputDir</span><span class="p">'</span><span class="w">   </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">'</span><span class="n">metadata</span><span class="o">/</span><span class="n">metarefresh</span><span class="o">-</span><span class="n">kalmar</span><span class="o">/</span><span class="p">',</span><span class="w"></span>
<span class="w">      </span><span class="p">'</span><span class="n">outputFormat</span><span class="p">'</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">'</span><span class="n">flatfile</span><span class="p">',</span><span class="w"></span>
<span class="w">    </span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="p">'</span><span class="n">uk</span><span class="p">'</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">array</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="p">'</span><span class="n">cron</span><span class="p">'</span><span class="w">    </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">array</span><span class="p">('</span><span class="n">hourly</span><span class="p">'),</span><span class="w"></span>
<span class="w">      </span><span class="p">'</span><span class="n">sources</span><span class="p">'</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">array</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">array</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="p">'</span><span class="n">src</span><span class="p">'</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">'</span><span class="nl">http:</span><span class="c1">//metadata.ukfederation.org.uk/ukfederation-metadata.xml',</span>
<span class="w">          </span><span class="p">'</span><span class="n">validateFingerprint</span><span class="p">'</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">'</span><span class="nl">D0:E8:</span><span class="mh">40</span><span class="o">:</span><span class="mh">25</span><span class="o">:</span><span class="nl">F0:B1:</span><span class="mh">2</span><span class="nl">A:CC:</span><span class="mh">74</span><span class="o">:</span><span class="mh">22</span><span class="o">:</span><span class="nl">ED:C3:</span><span class="mh">87</span><span class="o">:</span><span class="mh">04</span><span class="o">:</span><span class="nl">BC:</span><span class="mh">29</span><span class="o">:</span><span class="nl">BB:</span><span class="mh">7</span><span class="nl">B:</span><span class="mh">9</span><span class="nl">A:</span><span class="mh">40</span><span class="p">',</span><span class="w"></span>
<span class="w">        </span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="p">),</span><span class="w"></span>
<span class="w">      </span><span class="p">'</span><span class="n">expireAfter</span><span class="p">'</span><span class="w">     </span><span class="o">=&gt;</span><span class="w"> </span><span class="mh">60</span><span class="o">*</span><span class="mh">60</span><span class="o">*</span><span class="mh">24</span><span class="o">*</span><span class="mh">4</span><span class="p">,</span><span class="w"> </span><span class="c1">// Maximum 4 days cache time.</span>
<span class="w">      </span><span class="p">'</span><span class="n">outputDir</span><span class="p">'</span><span class="w">   </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">'</span><span class="n">metadata</span><span class="o">/</span><span class="n">metarefresh</span><span class="o">-</span><span class="n">ukaccess</span><span class="o">/</span><span class="p">',</span><span class="w"></span>
<span class="w">      </span><span class="p">'</span><span class="n">outputFormat</span><span class="p">'</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">'</span><span class="n">serialize</span><span class="p">',</span><span class="w"></span>
<span class="w">    </span><span class="p">),</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>
</code></pre>
</div>
<p>
 The configuration consists of one or more metadata sets. Each metadata set has its own configuration, representing a metadata set of sources.
Some federations will provide you with detailed instructions on how to configure metarefresh to fetch their metadata automatically, like,
for instance,
 <a href="https://spaces.internet2.edu/x/eYHFAg">
  the InCommon federation in the US
 </a>
 . Whenever a federation provides you with specific
instructions to configure metarefresh, be sure to use them from the authoritative source.
</p>
<p>
 The metarefresh module supports the following configuration options:
</p>
<dl>
 <dt>
  <code>
   cron
  </code>
 </dt>
 <dd>
  Which cron tags will refresh this metadata set.
 </dd>
 <dt>
  <code>
   sources
  </code>
 </dt>
 <dd>
  An array of metadata sources that will be included in this
  metadata set. The contents of this option will be described later in more detail.
 </dd>
 <dt>
  <code>
   expireAfter
  </code>
 </dt>
 <dd>
  The maximum number of seconds a metadata entry will be valid.
 </dd>
 <dt>
  <code>
   outputDir
  </code>
 </dt>
 <dd>
  The directory where the generated metadata will be stored. The path
  is relative to the SimpleSAMLphp base directory.
 </dd>
 <dt>
  <code>
   outputFormat
  </code>
 </dt>
 <dd>
  The format of the generated metadata files. This must match the
  metadata source added in
  <code>
   config.php
  </code>
  .
 </dd>
 <dt>
  <code>
   types
  </code>
 </dt>
 <dd>
  <p>
   The sets of entities to load. An array containing strings identifying the different types of entities that will be
  loaded. Valid types are:
  </p>
  <ul>
   <li>
    saml20-idp-remote
   </li>
   <li>
    saml20-sp-remote
   </li>
   <li>
    shib13-idp-remote
   </li>
   <li>
    shib13-sp-remote
   </li>
   <li>
    attributeauthority-remote
   </li>
  </ul>
  <p>
   All entity types will be loaded by default.
  </p>
 </dd>
</dl>
<p>
 Each metadata source has the following options:
</p>
<dl>
 <dt>
  <code>
   src
  </code>
 </dt>
 <dd>
  The source URL where the metadata will be fetched from.
 </dd>
 <dt>
  <code>
   certificates
  </code>
 </dt>
 <dd>
  An array of certificate files, the filename is relative to the
  <code>
   cert/
  </code>
  -directory,
  that will be used to verify the signature of the metadata. The public key will
  be extracted from the certificate and everything else will be ignored. So it is
  possible to use a self signed certificate that has expired. Add more than one
  certificate to be able to handle key rollover. This takes precedence over
  validateFingerprint.
 </dd>
 <dt>
  <code>
   validateFingerprint
  </code>
 </dt>
 <dd>
  The fingerprint of the certificate used to sign the metadata. You
  don't need this option if you don't want to validate the signature
  on the metadata.
 </dd>
 <dt>
  <code>
   template
  </code>
 </dt>
 <dd>
  This is an array which will be combined with the metadata fetched to
  generate the final metadata array.
 </dd>
 <dt>
  <code>
   types
  </code>
 </dt>
 <dd>
  Same as the option with the same name at the metadata set level. This option has precedence when both are specified,
  allowing a more fine grained configuration for every metadata source.
 </dd>
</dl>
<p>
 After you have configured the metadata sources, you need to give the
web-server write access to the output directories. Following the previous example:
</p>
<div class="codehilite">
 <pre><span></span><code><span class="n">chown</span><span class="w"> </span><span class="n">www</span><span class="o">-</span><span class="n">data</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">simplesamlphp</span><span class="o">/</span><span class="n">metadata</span><span class="o">/</span><span class="n">metarefresh</span><span class="o">-</span><span class="n">kalmar</span><span class="o">/</span><span class="w"></span>
<span class="n">chown</span><span class="w"> </span><span class="n">www</span><span class="o">-</span><span class="n">data</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">simplesamlphp</span><span class="o">/</span><span class="n">metadata</span><span class="o">/</span><span class="n">metarefresh</span><span class="o">-</span><span class="n">ukaccess</span><span class="o">/</span><span class="w"></span>
</code></pre>
</div>
<p>
 Now you can configure SimpleSAMLphp to use the metadata fetched by metarefresh. Edit the main
config.php file, and modify the
 <code>
  metadata.sources
 </code>
 directive accordingly:
</p>
<div class="codehilite">
 <pre><span></span><code>'metadata.sources' =&gt; array(
  array('type' =&gt; 'flatfile'),
  array('type' =&gt; 'flatfile', 'directory' =&gt; 'metadata/metarefresh-kalmar'),
  array('type' =&gt; 'serialize', 'directory' =&gt; 'metadata/metarefresh-ukaccess'),
),
</code></pre>
</div>
<p>
 Remember that the
 <code>
  type
 </code>
 parameter here must match the
 <code>
  outputFormat
 </code>
 in the configuration of the module.
</p>
<h2 id="configuring-the-cron-module">
 Configuring the cron module
</h2>
<p>
 See the
 <a href="./cron/cron.html">
  cron module documentation
 </a>
 to configure
 <code>
  cron
 </code>
</p>
<p>
 Once you have invoked cron, and if this operation seems to run fine, navigate to the
 <strong>
  SimpleSAMLphp Front page
 </strong>
 ›
 <strong>
  Federation
 </strong>
 . Here you will see a list of all the Identity Providers trusted. They will be listed with information about the maximum duration of their cached version, such as
 <em>
  (expires in 96.0 hours)
 </em>
 .
</p>
<p>
 You
 <em>
  may
 </em>
 need to adjust the below php.ini setings if the metadata files you consume are quite large.
</p>
<ul>
 <li>
  <code>
   memory_limit
  </code>
 </li>
 <li>
  <code>
   max_execution_time
  </code>
 </li>
</ul>
<h2 id="metadata-duration">
 Metadata duration
</h2>
<p>
 SAML metadata may supply a
 <code>
  cacheDuration
 </code>
 attribute which indicates the maximum time to keep metadata cached. Because this module is run from cron, it cannot decide how often it is run and enforce this duration on its own. Make sure to run metarefresh from cron at least as often as the shortest
 <code>
  cacheDuration
 </code>
 in your metadata sources.
</p></main></body>
</html>
