<!DOCTYPE html>
<html lang="en">
  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Language" content="en">
  <meta name="google-site-verification" content="2S8M18BgYs8cLRL6ClTrfW_xGxfFtMZu2b2jhjrNlss">

  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>SimpleSAMLphp Documentation</title>

  <link rel="stylesheet" href="/res/css/style.css">
  <link rel="stylesheet" href="/res/css/layout.css">
</head>
<body>
<header>
 <div id="header">
  <div class="right">
   <form action="https://www.google.com/cse" method="get" style="margin-top: 2.5rem; margin-right: 2rem">
    <input name="cx" type="hidden" value="004202914224971217557:8ks4jjstupq"/>
    <input name="siteurl" type="hidden" value="www.google.com/cse/home?cx=004202914224971217557:8ks4jjstupq"/>
    <input name="adkw" type="hidden" value="AELymgVJ6Sk-kOvUjbxvgShTLwiFlma2evFuVCh0r8q23vn_4eVnkcdnPfbgMvYUTpJpVlb-KkGAKkbn0i-AlWHsVRR9O0J4CNb6cXFkEKRdjXxsC_NlVD4"/>
    <input name="q" placeholder="Search" type="search" value=""/>
   </form>
  </div>
  <div class="v-center logo-header">
   <div id="logo">
    <a href="https://simplesamlphp.org" style="color: #fff; text-decoration: none">
     <span class="simple">
      Simple
     </span>
     <span class="saml">
      SAML
     </span>
     <span class="simple">
      php
     </span>
    </a>
   </div>
  </div>
 </div>
 <!-- Grey header bar below -->
 <nav>
  <div id="headerbar" style="clear: both">
   <p id="breadcrumb">
    <a href="https://simplesamlphp.org">
     Home
    </a>
    » Documentation
   </p>
   <div class="mtoolbar">
    <div class="menuitem">
     <a href="/docs/2.3/index.html">
      2.3 (stable)
     </a>
    </div>
    <div class="menuitem">
     <a href="/docs/2.2/index.html">
      2.2
     </a>
    </div>
    <div class="menuitem">
     <a href="/docs/2.1/index.html">
      2.1
     </a>
    </div>
    <div class="menuitem">
     <a href="/docs/2.0/index.html">
      2.0
     </a>
    </div>
    <div class="menuitem first">
     <a href="/docs/devel/index.html">
      devel
     </a>
    </div>
    <div class="menuitem last">
     <a href="/docs/contributed_modules.html">
      Contributed modules
     </a>
    </div>
   </div>
   <br style="height: 0px; clear: both"/>
  </div>
  <!-- /#headerbar -->
 </nav>
 <div id="content">
 </div>
</header>
<main><h1 id="setting-up-a-simplesamlphp-saml-20-idp-to-use-with-google-workspace-for-education">
 Setting up a SimpleSAMLphp SAML 2.0 IdP to use with Google Workspace for Education
</h1>
<div class="toc">
 <ul>
  <li>
   <a href="#setting-up-a-simplesamlphp-saml-20-idp-to-use-with-google-workspace-for-education">
    Setting up a SimpleSAMLphp SAML 2.0 IdP to use with Google Workspace for Education
   </a>
   <ul>
    <li>
     <a href="#introduction">
      Introduction
     </a>
    </li>
    <li>
     <a href="#enabling-the-identity-provider-functionality">
      Enabling the Identity Provider functionality
     </a>
    </li>
    <li>
     <a href="#setting-up-a-signing-certificate">
      Setting up a signing certificate
     </a>
    </li>
    <li>
     <a href="#authentication-source">
      Authentication source
     </a>
    </li>
    <li>
     <a href="#configuring-the-authentication-source">
      Configuring the authentication source
     </a>
    </li>
    <li>
     <a href="#configuring-metadata-for-an-saml-20-idp">
      Configuring metadata for an SAML 2.0 IdP
     </a>
     <ul>
      <li>
       <a href="#configuring-saml-20-idp-hosted-metadata">
        Configuring SAML 2.0 IdP Hosted metadata
       </a>
      </li>
      <li>
       <a href="#configuring-saml-20-sp-remote-metadata">
        Configuring SAML 2.0 SP Remote metadata
       </a>
      </li>
     </ul>
    </li>
    <li>
     <a href="#configure-google-workspace">
      Configure Google Workspace
     </a>
     <ul>
      <li>
       <a href="#add-a-user-in-google-workspace-that-is-known-to-the-idp">
        Add a user in Google Workspace that is known to the IdP
       </a>
      </li>
     </ul>
    </li>
    <li>
     <a href="#test-to-login-to-g-suite-for-education">
      Test to login to G Suite for education
     </a>
    </li>
    <li>
     <a href="#support">
      Support
     </a>
    </li>
   </ul>
  </li>
 </ul>
</div>
<h2 id="introduction">
 Introduction
</h2>
<p>
 This article describes how to configure a Google Workspace (formerly G Suite, formerly Google Apps)
instance as a service provider to use with a SimpleSAMLphp identity provider.
This article assumes that you have already read the SimpleSAMLphp installation manual, and installed
a version of SimpleSAMLphp at your server.
</p>
<p>
 In this example we will setup this server as an IdP for Google Workspace:
</p>
<p>
 dev2.andreas.feide.no
</p>
<h2 id="enabling-the-identity-provider-functionality">
 Enabling the Identity Provider functionality
</h2>
<p>
 Edit
 <code>
  config.php
 </code>
 , and enable the SAML 2.0 IdP:
</p>
<div class="highlight">
 <pre><span></span><code><span class="x">'enable.saml20-idp' =&gt; true,</span>
</code></pre>
</div>
<h2 id="setting-up-a-signing-certificate">
 Setting up a signing certificate
</h2>
<p>
 You must generate a certificate for your IdP.
Here is an example of an openssl command to generate a new key and a self signed certificate to use for signing SAML messages:
</p>
<div class="highlight">
 <pre><span></span><code>openssl<span class="w"> </span>req<span class="w"> </span>-newkey<span class="w"> </span>rsa:3072<span class="w"> </span>-new<span class="w"> </span>-x509<span class="w"> </span>-days<span class="w"> </span><span class="m">3652</span><span class="w"> </span>-nodes<span class="w"> </span>-out<span class="w"> </span>googleworkspaceidp.crt<span class="w"> </span>-keyout<span class="w"> </span>googleworkspaceidp.pem
</code></pre>
</div>
<p>
 The certificate above will be valid for 10 years.
</p>
<p>
 Here is an example of typical user input when creating a certificate request:
</p>
<div class="highlight">
 <pre><span></span><code>Country<span class="w"> </span>Name<span class="w"> </span><span class="o">(</span><span class="m">2</span><span class="w"> </span>letter<span class="w"> </span>code<span class="o">)</span><span class="w"> </span><span class="o">[</span>AU<span class="o">]</span>:NO
State<span class="w"> </span>or<span class="w"> </span>Province<span class="w"> </span>Name<span class="w"> </span><span class="o">(</span>full<span class="w"> </span>name<span class="o">)</span><span class="w"> </span><span class="o">[</span>Some-State<span class="o">]</span>:Trondheim
Locality<span class="w"> </span>Name<span class="w"> </span><span class="o">(</span>eg,<span class="w"> </span>city<span class="o">)</span><span class="w"> </span><span class="o">[]</span>:Trondheim
Organization<span class="w"> </span>Name<span class="w"> </span><span class="o">(</span>eg,<span class="w"> </span>company<span class="o">)</span><span class="w"> </span><span class="o">[</span>Internet<span class="w"> </span>Widgits<span class="w"> </span>Pty<span class="w"> </span>Ltd<span class="o">]</span>:UNINETT
Organizational<span class="w"> </span>Unit<span class="w"> </span>Name<span class="w"> </span><span class="o">(</span>eg,<span class="w"> </span>section<span class="o">)</span><span class="w"> </span><span class="o">[]</span>:
Common<span class="w"> </span>Name<span class="w"> </span><span class="o">(</span>eg,<span class="w"> </span>YOUR<span class="w"> </span>name<span class="o">)</span><span class="w"> </span><span class="o">[]</span>:dev2.andreas.feide.no
Email<span class="w"> </span>Address<span class="w"> </span><span class="o">[]</span>:

Please<span class="w"> </span>enter<span class="w"> </span>the<span class="w"> </span>following<span class="w"> </span><span class="s1">'extra'</span><span class="w"> </span>attributes
to<span class="w"> </span>be<span class="w"> </span>sent<span class="w"> </span>with<span class="w"> </span>your<span class="w"> </span>certificate<span class="w"> </span>request
A<span class="w"> </span>challenge<span class="w"> </span>password<span class="w"> </span><span class="o">[]</span>:
An<span class="w"> </span>optional<span class="w"> </span>company<span class="w"> </span>name<span class="w"> </span><span class="o">[]</span>:
</code></pre>
</div>
<p>
 <strong>
  Note
 </strong>
 : SimpleSAMLphp will only work with RSA and not DSA certificates.
</p>
<h2 id="authentication-source">
 Authentication source
</h2>
<p>
 The next step is to configure the way users authenticate on your IdP. Various modules in the
 <code>
  modules/
 </code>
 directory provides methods for authenticating your users. This is an overview of those that are included in the SimpleSAMLphp distribution:
</p>
<dl>
 <dt>
  <code>
   exampleauth:UserPass
  </code>
 </dt>
 <dd>
  Authenticate against a list of usernames and passwords.
 </dd>
 <dt>
  <code>
   exampleauth:Static
  </code>
 </dt>
 <dd>
  Automatically log in as a user with a set of attributes.
 </dd>
 <dt>
  <a href="/docs/contrib_modules/ldap/ldap.html">
   <code>
    ldap:LDAP
   </code>
  </a>
 </dt>
 <dd>
  Authenticates an user to a LDAP server.
 </dd>
</dl>
<p>
 For more authentication modules, see
 <a href="simplesamlphp-idp.html">
  SimpleSAMLphp Identity Provider QuickStart
 </a>
 .
</p>
<p>
 In this guide, we will use the
 <code>
  exampleauth:UserPass
 </code>
 authentication module. This module does not have any dependencies, and is therefore simple to set up.
</p>
<p>
 After you have successfully tested that everything is working with the simple
 <code>
  exampleauth:UserPass
 </code>
 , you are encouraged to setup SimpleSAMLphp IdP towards your user storage, such as an LDAP directory. (Use the links on the authentication sources above to read more about these setups.
 <code>
  ldap:LDAP
 </code>
 is the most common authentication source.)
</p>
<h2 id="configuring-the-authentication-source">
 Configuring the authentication source
</h2>
<p>
 The
 <code>
  exampleauth:UserPass
 </code>
 authentication module is part of the
 <code>
  exampleauth
 </code>
 module. This module isn't enabled by default, so you will have to enable it. In
 <code>
  config.php
 </code>
 , search for the
 <code>
  module.enable
 </code>
 key and set
 <code>
  exampleauth
 </code>
 to true:
</p>
<div class="highlight">
 <pre><span></span><code><span class="x">'module.enable' =&gt; [</span>
<span class="x">    'exampleauth' =&gt; true,</span>
<span class="x">    …</span>
<span class="x">],</span>
</code></pre>
</div>
<p>
 The next step is to create an authentication source with this module. An authentication source is an authentication module with a specific configuration. Each authentication source has a name, which is used to refer to this specific configuration in the IdP configuration. Configuration for authentication sources can be found in
 <code>
  config/authsources.php
 </code>
 .
</p>
<p>
 In this example we will use
 <code>
  example-userpass
 </code>
 , and hence that section is what matters and will be used.
</p>
<div class="highlight">
 <pre><span></span><code><span class="cp">&lt;?php</span>

<span class="nv">$config</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'example-userpass'</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="s1">'exampleauth:UserPass'</span><span class="p">,</span>
        <span class="s1">'student:studentpass'</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">'uid'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'student'</span><span class="p">],</span>
        <span class="p">],</span>
        <span class="s1">'employee:employeepass'</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="s1">'uid'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'employee'</span><span class="p">],</span>
        <span class="p">],</span>
    <span class="p">],</span>
<span class="p">];</span>
</code></pre>
</div>
<p>
 This configuration creates two users -
 <code>
  student
 </code>
 and
 <code>
  employee
 </code>
 , with the passwords
 <code>
  studentpass
 </code>
 and
 <code>
  employeepass
 </code>
 . The username and password are stored in the array index
 <code>
  student:studentpass
 </code>
 for the
 <code>
  student
 </code>
 -user. The attributes (only
 <code>
  uid
 </code>
 in this example) will be returned by the IdP when the user logs on.
</p>
<h2 id="configuring-metadata-for-an-saml-20-idp">
 Configuring metadata for an SAML 2.0 IdP
</h2>
<p>
 If you want to setup a SAML 2.0 IdP for Google Workspace, you need to configure two metadata files:
 <code>
  saml20-idp-hosted.php
 </code>
 and
 <code>
  saml20-sp-remote.php
 </code>
 .
</p>
<h3 id="configuring-saml-20-idp-hosted-metadata">
 Configuring SAML 2.0 IdP Hosted metadata
</h3>
<p>
 This is the configuration of the IdP itself. Here is some example config:
</p>
<div class="highlight">
 <pre><span></span><code><span class="x">// The SAML entity ID is the index of this config.</span>
<span class="x">$metadata['https://example.org/saml-idp'] = [</span>
<span class="x">    // The hostname of the server (VHOST) that this SAML entity will use.</span>
<span class="x">    'host' =&gt; '__DEFAULT__',</span>

<span class="x">    // X.509 key and certificate. Relative to the cert directory.</span>
<span class="x">    'privatekey'   =&gt; 'googleworkspaceidp.pem',</span>
<span class="x">    'certificate'  =&gt; 'googleappsidp.crt',</span>

<span class="x">    'auth' =&gt; 'example-userpass',</span>
<span class="x">]</span>
</code></pre>
</div>
<p>
 <strong>
  Note
 </strong>
 : You can only have one entry in the file with host equal to
 <code>
  __DEFAULT__
 </code>
 , therefore you should replace the existing entry with this one, instead of adding this entry as a new entry in the file.
</p>
<h3 id="configuring-saml-20-sp-remote-metadata">
 Configuring SAML 2.0 SP Remote metadata
</h3>
<p>
 In the
 <code>
  saml20-sp-remote.php
 </code>
 file we will configure an entry for Google Workspace for Education. There is already an entry for Google Workspace in the template, but we will change the domain name:
</p>
<div class="highlight">
 <pre><span></span><code><span class="x">/*</span>
<span class="x"> * This example shows an example config that works with Google Workspace for education.</span>
<span class="x"> * You send the email address that identifies the user from your IdP in the SAML Name ID.</span>
<span class="x"> */</span>
<span class="x">$metadata['https://www.google.com/a/g.feide.no'] = [</span>
<span class="x">    'AssertionConsumerService' =&gt; 'https://www.google.com/a/g.feide.no/acs',</span>
<span class="x">    'NameIDFormat' =&gt; 'urn:oasis:names:tc:SAML:1.1:nameid-format:emailAddress',</span>
<span class="x">    'simplesaml.attributes' =&gt; false,</span>
<span class="x">    'authproc' =&gt; [</span>
<span class="x">        1 =&gt; [</span>
<span class="x">          'class' =&gt; 'saml:AttributeNameID',</span>
<span class="x">          'identifyingAttribute' =&gt; 'mail',</span>
<span class="x">          'Format' =&gt; 'urn:oasis:names:tc:SAML:1.1:nameid-format:emailAddress',</span>
<span class="x">        ],</span>
<span class="x">    ],</span>
<span class="x">];</span>
</code></pre>
</div>
<p>
 You should modify the entityID above and the
 <code>
  AssertionConsumerService
 </code>
 to
include your Google Workspace domain name instead of
 <code>
  g.feide.no
 </code>
 .
</p>
<p>
 (It is also possible to send only the local part of the email address to Google. E.g.
for an e-mail address at GW
 <code>
  student@g.feide.no
 </code>
 , sending an attribute with the
value
 <code>
  student
 </code>
 .)
</p>
<h2 id="configure-google-workspace">
 Configure Google Workspace
</h2>
<p>
 Start by logging in to our Google Workspace for education account panel.
Then select "Advanced tools":
</p>
<p>
 Figure 1.
 <strong>
  We go to advanced tools
 </strong>
</p>
<p>
 <img alt="We go to advanced tools" src="resources/simplesamlphp-googleapps/googleapps-menu.png"/>
</p>
<p>
 Then select "Set up single sign-on (SSO)":
</p>
<p>
 Figure 2.
 <strong>
  We go to setup SSO
 </strong>
</p>
<p>
 <img alt="We go to setup SSO" src="resources/simplesamlphp-googleapps/googleapps-sso.png"/>
 Upload a certificate, such as the googleworkspaceidp.crt created above:
</p>
<p>
 Figure 3.
 <strong>
  Uploading certificate
 </strong>
</p>
<p>
 <img alt="Uploading certificate" src="resources/simplesamlphp-googleapps/googleapps-cert.png"/>
 Fill out the remaining fields:
</p>
<p>
 The most important field is the Sign-in page URL. You can find the
correct value in your IdP metadata. Browse to your simpleSAMLphp installation,
go to the "Federation" tab, under "SAML 2.0 IdP Metadata" select "show metadata".
</p>
<p>
 You will find in the metadata the XML tag
 <code>
  &lt;md:SingleSignOnService&gt;
 </code>
 which contains the right URL to input in the field, it will look something
like this:
</p>
<p>
 <code>
  https://dev2.andreas.feide.no/simplesaml/module.php/saml/idp/singleSignOnService
 </code>
</p>
<p>
 The Sign-out page or change password URL can be static pages on your server.
(Google does not support SAML Single Log Out.)
</p>
<p>
 The network mask determines which IP addresses will be asked for SSO login.
IP addresses not matching this mask will be presented with the normal Google Workspace login page.
It is normally best to leave this field empty to enable authentication for all URLs.
</p>
<p>
 Figure 4.
 <strong>
  Fill out the remaining fields
 </strong>
</p>
<p>
 <img alt="Fill out the remaining fields" src="resources/simplesamlphp-googleapps/googleapps-ssoconfig.png"/>
</p>
<h3 id="add-a-user-in-google-workspace-that-is-known-to-the-idp">
 Add a user in Google Workspace that is known to the IdP
</h3>
<p>
 Before we can test login, a new user must be defined in Google Workspace. This user must have a mail field matching the email from the attribute as described above in the metadata section.
</p>
<h2 id="test-to-login-to-g-suite-for-education">
 Test to login to G Suite for education
</h2>
<p>
 Go to the URL of your mail account for this domain, the URL is similar to the following:
</p>
<p>
 <code>
  http://mail.google.com/a/yourgoogleworkspacedomain.com
 </code>
</p>
<p>
 replacing the last part with your own Google Workspace domain name.
</p>
<h2 id="support">
 Support
</h2>
<p>
 If you need help to make this work, or want to discuss SimpleSAMLphp with other users of the software, you are fortunate: Around SimpleSAMLphp there is a great Open source community, and you are welcome to join! The forums are open for you to ask questions, contribute answers other further questions, request improvements or contribute with code or plugins of your own.
</p>
<ul>
 <li>
  <a href="https://simplesamlphp.org">
   SimpleSAMLphp homepage
  </a>
 </li>
 <li>
  <a href="https://simplesamlphp.org/docs/">
   List of all available SimpleSAMLphp documentation
  </a>
 </li>
 <li>
  <a href="https://simplesamlphp.org/lists">
   Join the SimpleSAMLphp user's mailing list
  </a>
 </li>
</ul>
</main></body>
</html>
